groups:
  - name: mqtt_sensors
    rules:
      - alert: WaterLevelHigh
        expr: 'mqtt_consumer_s2{service_id="hem-wc-prod"} > 0'
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Water Level High"
          description: "Water Level high for extended period"
      - alert: ManualModeTooLong
        expr: 'mqtt_consumer_relay_mode{service_id="hem-wc-prod"} < 1'
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Manual Mode Too Long"
          description: "Manual Mode for extended period, need to set to auto relay mode back soon"
      - alert: MqttConsumerLostConnections
        expr: 'mqtt_consumer_lost_connections{service_id="hem-wc-prod"} > 1'
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "MQTT consumer lost connections"
          description: "Lost connections > 1 for 30 minutes"
      - alert: WaterLevelSensorMismatch
        expr: 'mqtt_consumer_s1{service_id="hem-wc-prod"} == 1 and mqtt_consumer_s0{service_id="hem-wc-prod"} == 0'
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Water level sensor mismatch"
          description: "S1 is high while S0 is low, possible sensor error"
      - alert: PumpOnNoFlow
        expr: 'mqtt_consumer_r0{service_id="hem-wc-prod"} == 1 and mqtt_consumer_minute_volume{service_id="hem-wc-prod"} < 0.5'
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Pump running without flow"
          description: "Pump relay is on but minute volume is zero for over 2 minutes"
  - name: telegraf_health
    rules:
      - alert: TelegrafDown
        expr: 'up{job="telegraf_mqtt_data"} == 0'
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Telegraf scrape down"
          description: "Prometheus cannot scrape Telegraf (job=telegraf_mqtt_data) for 2 minutes"

  - name: consul_service_health
    rules:
      - alert: ConsulMetricsMissing
        expr: 'absent(consul_health_service_status) == 1'
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Consul metrics missing"
          description: "Consul health metrics are missing for more than 1 minute"
      - alert: MqttServiceCritical
        expr: 'consul_health_service_status{service_name="mqtt",status="critical"} == 1'
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MQTT service down"
          description: "Consul reports mqtt service in critical state for over 1 minute"
      - alert: VaultServiceCritical
        expr: 'consul_health_service_status{service_name="vault",status="critical"} == 1'
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Vault service down"
          description: "Consul reports vault service in critical state for over 1 minute"
  - name: manual_trigger
    rules:
      - alert: ManualTestAlert
        expr: manual_test_alert{job="manual_test_alert"} == 1
        for: 10s
        labels:
          severity: info
        annotations:
          summary: "Manual test alert"
          description: "Triggered via Pushgateway to verify Alertmanager routing"
